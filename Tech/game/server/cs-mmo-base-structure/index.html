<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    
    <title>C/S MMO游戏的基本结构 | Ray Taylor Lin&#39;s world</title>
    <meta name="author" content="林寿山">
    
    <meta name="description" content="1.
搭建系统基本结构的目的是明确设计方针，可以从以下两方面考虑：

确认期望的同时连接数，以及能否免费进行游戏等商业模式
确认预想的瓶颈内容，并选择用来避免瓶颈的扩展方式

为了满足第一点，服务器必须具有可扩展性。由于无法预知游戏什么时候会火起来，所以最初发布时应该将服务器设备限制在最低程度，而且">
    
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <meta property="og:title" content="C/S MMO游戏的基本结构"/>
    <meta property="og:site_name" content="林寿山的技术博客 Ray Taylor Lin&#39;s world"/>

    <link rel="alternate" href="/atom.xml" title="Ray Taylor Lin&#39;s world" type="application/atom+xml">
    <link rel="stylesheet" href="/css/lib/font-awesome.css" type="text/css">
    <link rel="stylesheet" href="/css/lib/normalize.css" type="text/css">
    <link rel="stylesheet" href="/css/lib/furatto.css" type="text/css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

    
        <link rel="stylesheet" href="/css/lib/prettify_raytaylorism.css" type="text/css">
        
    
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <script src="/js/jquery-1.10.2.min.js"></script>
    <script src="/js/jquery.jpanelmenu.js"></script>
</head>


<body class="container-fluid">
    <header id="page-header">
        <div class="navbar inverse-navbar">
    <div class="navbar-inner">
        <div class="container-center">
            <a href="/index.html" class="menu-trigger" data-meteocon="M">
                <i class="icon-reorder"></i>
            </a>
            <div class="nav-collapse navbar-responsive-collapse collapse">
                <nav id="menu">
                    <ul class="nav">
                        <li><a class="brand" id="blog-title" href="/index.html">Ray Taylor Lin&#39;s world</a></li>
                    </ul>
                    <div class="pull-right nav" id="nav-button-group">
                        
                            <a href="/" class="menu-home btn btn-primary btn-large">
                                <i class="icon-home icon-white"></i>
                                首页
                            </a>
                        
                            <a href="/archives" class="menu-archive btn btn-primary btn-large">
                                <i class="icon-archive icon-white"></i>
                                归档
                            </a>
                        
                            <a href="javascript:void(0);" class="menu-category btn btn-primary btn-large">
                                <i class="icon-archive icon-white"></i>
                                分类
                            </a>
                        
                            <a href="/reading" class="menu-reading btn btn-primary btn-large">
                                <i class="icon-book icon-white"></i>
                                读书
                            </a>
                        
                            <a href="/about" class="menu-about btn btn-primary btn-large">
                                <i class="icon-user icon-white"></i>
                                关于
                            </a>
                        
                    </div>
                </nav>
                <nav id="jPanelMenu-menu-side">
    <ul class="nav main-menu">
        <li><a class="brand" href="index.html">Ray Taylor Lin&#39;s world</a></li>
        
            <li>
                <a href="/" class="menu-home">
                    <i class="icon-home icon-white"></i>
                    首页
                </a>
            </li>
        
            <li>
                <a href="/archives" class="menu-archive">
                    <i class="icon-archive icon-white"></i>
                    归档
                </a>
            </li>
        
            <li>
                <a href="javascript:void(0);" class="menu-category">
                    <i class="icon-archive icon-white"></i>
                    分类
                </a>
            </li>
        
            <li>
                <a href="/reading" class="menu-reading">
                    <i class="icon-book icon-white"></i>
                    读书
                </a>
            </li>
        
            <li>
                <a href="/about" class="menu-about">
                    <i class="icon-user icon-white"></i>
                    关于
                </a>
            </li>
        
    </ul>

    <ul class="nav category-menu hide">
        <li>
            <span><a class="brand" href="javascript:void(0);">分类目录</a></span>
            <span><a class="btn-back brand pull-right" href="javascript:void(0);">
                <i class="icon-arrow-left"></i>
            </a></span>
        </li>

        

        

            

            <li collapse-level="0">
                <a href="/categories/Tech/" class="collapse-level-0">
                    <i class="icon-caret-right"></i>
                    Tech(59)
                </a>
            </li>

            

            

            <li collapse-level="1">
                <a href="/categories/Tech/game/" class="collapse-level-1">
                    <i class="icon-caret-right"></i>
                    game(4)
                </a>
            </li>

            

            

            <li collapse-level="2">
                <a href="/categories/Tech/game/server/" class="collapse-level-2">
                    <i class="icon-caret-right"></i>
                    server(3)
                </a>
            </li>

            

            

        

        

            <li collapse-level="1">
                <a href="/categories/Tech/other/" class="collapse-level-1">
                    <i class="icon-caret-right"></i>
                    other(3)
                </a>
            </li>

            

            

            <li collapse-level="2">
                <a href="/categories/Tech/other/DP/" class="collapse-level-2">
                    <i class="icon-caret-right"></i>
                    DP(1)
                </a>
            </li>

            

            

        

        

            <li collapse-level="1">
                <a href="/categories/Tech/algorithm/" class="collapse-level-1">
                    <i class="icon-caret-right"></i>
                    algorithm(6)
                </a>
            </li>

            

            

        

            <li collapse-level="1">
                <a href="/categories/Tech/Linux/" class="collapse-level-1">
                    <i class="icon-caret-right"></i>
                    Linux(2)
                </a>
            </li>

            

            

        

            <li collapse-level="1">
                <a href="/categories/Tech/IDE/" class="collapse-level-1">
                    <i class="icon-caret-right"></i>
                    IDE(2)
                </a>
            </li>

            

            

        

            <li collapse-level="1">
                <a href="/categories/Tech/git/" class="collapse-level-1">
                    <i class="icon-caret-right"></i>
                    git(4)
                </a>
            </li>

            

            

        

            <li collapse-level="1">
                <a href="/categories/Tech/Script/" class="collapse-level-1">
                    <i class="icon-caret-right"></i>
                    Script(15)
                </a>
            </li>

            

            

            <li collapse-level="2">
                <a href="/categories/Tech/Script/Lua/" class="collapse-level-2">
                    <i class="icon-caret-right"></i>
                    Lua(7)
                </a>
            </li>

            

            

        

            <li collapse-level="2">
                <a href="/categories/Tech/Script/Python/" class="collapse-level-2">
                    <i class="icon-caret-right"></i>
                    Python(4)
                </a>
            </li>

            

            

        

        

            <li collapse-level="1">
                <a href="/categories/Tech/web/" class="collapse-level-1">
                    <i class="icon-caret-right"></i>
                    web(23)
                </a>
            </li>

            

            

            <li collapse-level="2">
                <a href="/categories/Tech/web/HTTP/" class="collapse-level-2">
                    <i class="icon-caret-right"></i>
                    HTTP(7)
                </a>
            </li>

            

            

        

            <li collapse-level="2">
                <a href="/categories/Tech/web/HTML5/" class="collapse-level-2">
                    <i class="icon-caret-right"></i>
                    HTML5(2)
                </a>
            </li>

            

            

        

            <li collapse-level="2">
                <a href="/categories/Tech/web/CSS/" class="collapse-level-2">
                    <i class="icon-caret-right"></i>
                    CSS(3)
                </a>
            </li>

            

            

        

            <li collapse-level="2">
                <a href="/categories/Tech/web/Node-js/" class="collapse-level-2">
                    <i class="icon-caret-right"></i>
                    Node-js(10)
                </a>
            </li>

            

            

        

            <li collapse-level="2">
                <a href="/categories/Tech/web/javascript/" class="collapse-level-2">
                    <i class="icon-caret-right"></i>
                    javascript(1)
                </a>
            </li>

            

            

        

        

        

            <li collapse-level="0">
                <a href="/categories/daily/" class="collapse-level-0">
                    <i class="icon-caret-right"></i>
                    daily(6)
                </a>
            </li>

            

            

        

        
    </ul>
</nav>
            </div>
        </div>
    </div>
</div>

    </header>
    <div id="content-wrapper">
        <div class="container-center">
        <article class="post">
    <div class="article-title article-title-big">
        
    
        <h1>C/S MMO游戏的基本结构</h1>
    

    </div>

    <div class="date-row ">
        <time datetime="2015-11-30T09:38:06.000Z">2015-11-30</time>
    </div>

    <div class="toc-wrap">
        <div class="toc-title">目录</div>
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-"><span class="toc-number">1.</span> <span class="toc-text">1.</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-_MMO系统的瓶颈"><span class="toc-number">2.</span> <span class="toc-text">2. MMO系统的瓶颈</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1_客户端瓶颈"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 客户端瓶颈</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2_服务器/数据库瓶颈"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 服务器/数据库瓶颈</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-_系统设计实例"><span class="toc-number">3.</span> <span class="toc-text">3. 系统设计实例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1_根据游戏逻辑的处理成本来估算"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 根据游戏逻辑的处理成本来估算</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2_根据游戏数据库的处理符合进行估算"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 根据游戏数据库的处理符合进行估算</span></a></li></ol></li></ol>
    </div>

    <div class="entry">
        <a id="more"></a>

<h1 id="1-">1.</h1>
<p>搭建系统基本结构的目的是明确设计方针，可以从以下两方面考虑：</p>
<ul>
<li>确认期望的同时连接数，以及能否免费进行游戏等商业模式</li>
<li>确认预想的瓶颈内容，并选择用来避免瓶颈的扩展方式</li>
</ul>
<p>为了满足第一点，服务器必须具有可扩展性。由于无法预知游戏什么时候会火起来，所以最初发布时应该将服务器设备限制在最低程度，而且之后即使访问量增加，也必须能够在不改变程序和设计的情况下，通过简单地增加服务器来支持新增的大量玩家。</p>
<h1 id="2-_MMO系统的瓶颈">2. MMO系统的瓶颈</h1>
<p>C/S MMO架构的服务器系统主要分为4个部分（其中cli为客户端上的终端程序），这4个部分可能产生的瓶颈如下图所示：</p>
<p><img src="http://raytaylorlin-blog.qiniudn.com/image/server/CS%20MMO系统和产生瓶颈的地方.jpg" alt="C/S MMO系统和产生瓶颈的地方"></p>
<h2 id="2-1_客户端瓶颈">2.1 客户端瓶颈</h2>
<p>通常游戏客户端的性能瓶颈产生在“游戏处理”和“渲染处理”两方面，而在MMO架构中，游戏处理全部都在服务器上，所以只会在“渲染处理”上产生瓶颈。渲染就是从磁盘中读取模型和纹理数据，并将其交给GPU加以处理，按照速度从慢到快排列，依次是磁盘-&gt;内存、内存-&gt;GPU内存、GPU内存内部传输。</p>
<p>在MMO游戏中，游戏过程中所需图像是无法完全确定的，例如有各种各样装扮的玩家，不断变化的地图等等。因此必须有一种动态从内存或磁盘中加载资源的方案，通常可以采用以下方法来避免游戏体验恶化：</p>
<ul>
<li>不要一口气读取所有必需的数据，而是在保持帧率的情况下花时间一点点读取</li>
<li>即使是在读取纹理数据的过程中，也尽量先进行轮廓的渲染，对所处位置有所了解</li>
<li>需要读取大量数据时（如转场），加上Loading界面</li>
</ul>
<p>关于带宽瓶颈，除了那些要持续加载图像数据的游戏或者要传输几十G的庞大差分数据，其他情况下都不会有问题，此处不做讨论。</p>
<h2 id="2-2_服务器/数据库瓶颈">2.2 服务器/数据库瓶颈</h2>
<p>解决服务器（以下1和2）和数据库（以下3）瓶颈主要有以下方法，这些方法在WoW也有采用：</p>
<ol>
<li>空间分割法：根据地理结构将游戏世界进行分割，分配给其他服务器进程或设备处理。例如，一个服务器处理世界中一个地图板块或一块大陆。但是这种方法不能应对大量玩家聚集在一个特定区域（如主城）的情况。</li>
<li>实例法：将负荷特别高的、用户集中在一起的部分独立出来，分配给专用的服务器处理。这也称为<strong>游戏副本实例</strong>。副本服务器通常并行地运行着多个副本实例，当玩家从这一狭小区域退出时，就会自动回到原来的地方，并交由负责整个世界的服务器处理。</li>
<li>平行世界方式：将保存玩家信息的数据库分成多个，这样角色就无法在不同的世界之间移动，交流也被切断。这就是常见的分区分服。这种方式导致的问题是游戏角色资料的转移（转服）会受到限制，在转移时还需要对玩家和玩家团体（公会或帮会等）的昵称等命名相关信息进行检测以防止冲突。</li>
</ol>
<p>普通的Web服务访问模式中，数据库写入操作频率不到读取频率的10%，但在网络游戏中却正好相反，写入操作占了90%，这是因为MMO游戏中玩家角色的状态会频繁变化，而状态的变化是局部于用户ID的。所以执行写入缓存的中间高速缓存服务器在C/S MMO系统中是必不可少的。</p>
<p><img src="http://raytaylorlin-blog.qiniudn.com/image/server/同时采用空间分割法、副本实例法和平行世界方式结构图.jpg" alt="同时采用空间分割法、副本实例法和平行世界方式结构图"></p>
<h1 id="3-_系统设计实例">3. 系统设计实例</h1>
<p><strong>目标：假设要设计一个同时在线玩家数为3W的游戏</strong>（此处以书中假想的K Online游戏为例，与市面上流行的MMORPG类似。以下情况均为设想，在阅读过程中不必拘泥于游戏的具体策划，可以结合WoW等经典的MMORPG来理解，重点是理解如何分析并估算服务器成本。）</p>
<p>设计估算的基本原则：</p>
<ul>
<li>对特别耗费处理成本的部分进行估计，求出“绝对的服务器数量”①</li>
<li>对特别难以扩展的部分进行估计，求出“每个平行世界可能扩充的最大服务器数”②</li>
<li>平行世界数=①/②</li>
</ul>
<h2 id="3-1_根据游戏逻辑的处理成本来估算">3.1 根据游戏逻辑的处理成本来估算</h2>
<p>公式：<strong>[同时在线数]</strong>×每个玩家所面对的敌人数×每秒敌人行动次数×每次行动需要的CPU时间×安全系数=1秒（此处“同时在线数”即为要求解的值）</p>
<ul>
<li>每个玩家所面对的敌人数：最坏情况下，每个玩家可能同时面对10~20个左右的敌人</li>
<li>每秒敌人行动次数：策划要求每秒处理5次</li>
<li>每次行动需要的CPU时间：可以编写小段程序验证以下几个方面的处理时间，可估算出每次行动平均需要10微妙<ol>
<li>通过简单的循环来检查敌人周围的地形数据</li>
<li>查找附近的玩家角色</li>
<li>通过非常简单的排序方法来决定下一次行动</li>
<li>执行1次预定的行动</li>
</ol>
</li>
<li>安全系数：这是一个应对最坏情况的“余量”，设定为2倍</li>
</ul>
<p>将以上数值代入公式可求得[同时在线数]≈500，这是单核CPU的运算量估计。对于3W的同时在线数，则需要3W/500=60个内核所具有的处理能力。</p>
<h2 id="3-2_根据游戏数据库的处理符合进行估算">3.2 根据游戏数据库的处理符合进行估算</h2>
<p>公式：同时在线数×每个连接平均的数据存储频率×1次存储所需查询数×安全系数=数据库服务器总共可以查询的数量（数据库的写入性能起决定性作用）</p>
<p>参考文献：人民邮电出版社《网络游戏核心技术与实战》第4章</p>

    </div>
    
    <footer >
        
            
    
    <div class="categories">
        所属目录：
    <a href="/categories/Tech/">Tech</a> -> <a href="/categories/Tech/game/">game</a> -> <a href="/categories/Tech/game/server/">server</a>
    </div>

            
    
    <div class="tags-row">
        标签：<a class="btn btn-info" href="/tags/网络游戏编程/">网络游戏编程</a>
    </div>

        
        <div class="clearfix"></div>
    </footer>
</article>



<section id="comment">
    <h1 class="page-sub-title">留言</h1>
    <!-- Duoshuo Comment BEGIN -->
    <div class="ds-thread" data-title="C/S MMO游戏的基本结构">

    <script type="text/javascript">
        var duoshuoQuery = {short_name:"raytaylorlin"};
        (function() {
            var ds = document.createElement('script');
            ds.type = 'text/javascript';
            ds.async = true;
            ds.src = 'http://static.duoshuo.com/embed.js';
            ds.charset = 'UTF-8';
            (document.getElementsByTagName('head')[0] 
            || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
    </script>
    <!-- Duoshuo Comment END -->
    </div>
</section>


        </div>
    </div>
    <footer id="page-footer"><div class="footer-content">
    <div class="container-center">
        <div class="footer-text pull-left">
            <div class="copyright">
                
                Copyright &copy; 2015 <a href="/">林寿山</a>
                
            </div>
            <div class="theme-copyright">
                <span>Blog powered by <a href="http://zespia.tw/hexo/zh-CN/">hexo</a></span>
                Theme <a href="https://github.com/raytaylorlin/hexo-theme-raytaylorism">raytaylorism</a> desgined by <strong>Nix</strong>
            </div>
        </div>
        <div class="social-group pull-right">
            
            <a href="https://github.com/raytaylorlin" target="_blank" title="github"><i class="icon-github"></i></a>
            
            
            <a href="http://weibo.com/1956184117" target="_blank" title="新浪微博"><i class="icon-weibo"></i></a>
            
            
            <a href="http://www.renren.com/309069699" target="_blank" title="人人网"><i class="icon-renren"></i></a>
            
            
            <a href="https://plus.google.com/113216251417550089742?rel=author" target="_blank" title="Google+"><i class="icon-google-plus-sign"></i></a>
            
        </div>
        <div class="clearfix"></div>
    </div>
</div>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-43460643-1', 'raytaylorlin.com');
    ga('send', 'pageview');

</script>


<script src="/js/prettify.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $("pre").addClass("prettyprint");
        prettyPrint();
    });
</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>
<script type="text/javascript"
    src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<script>
    (function($) {
        //当内容区内容不够长时，设置内容区域的高度使footer沉底
        var resizeContentWrapper = function() {
            //HACK: 用延时的方法使计算高度时候更加准确，会有一闪的情况
            setTimeout(function() {
                var contentHeight = Math.floor($('#content-wrapper .container-center').height()),
                headerHeight = Math.floor($('#page-header').height()),
                footerHeight = Math.floor($('#page-footer').height()),
                minHeight = Math.floor($(window).height() - headerHeight - footerHeight);
                if(contentHeight < minHeight) {
                    $('#content-wrapper').css({height: minHeight});                    
                } else {
                    $('#content-wrapper').css({height: 'auto'});
                }
            },500);
        };

        //响应式侧边栏
        var initJPanelMenu = function() {
            var jPM = $.jPanelMenu({
                menu: '#jPanelMenu-menu-side',
                duration: 500
            });
            jPM.on();
        };

        //初始化目录按钮事件绑定
        var initCategory = function() {
            function showMainMenu() {
                var $jPanelMenu = $('#jPanelMenu-menu');
                $jPanelMenu.find('ul.category-menu').hide();
                $jPanelMenu.find('ul.main-menu').fadeIn();
            }

            function showCategoryMenu() {
                var $jPanelMenu = $('#jPanelMenu-menu');
                $jPanelMenu.find('ul.main-menu').hide();
                $jPanelMenu.find('ul.category-menu').fadeIn();
            }

            $('.menu-category').click(function() {
                var jPM = $.jPanelMenu({
                    duration: 500,
                    beforeOpen: function() {
                        showCategoryMenu();
                    },
                    afterClose: function() {
                        showMainMenu();
                    }
                });
                if(jPM.isOpen()) {
                    showCategoryMenu();
                } else {
                    jPM.open();
                }
            });

            $('.category-menu').on('click', '.btn-back', function() {
                showMainMenu();
            });
        };

        $(document).ready(resizeContentWrapper);
        $(document).ready(initJPanelMenu);
        $(document).ready(initCategory);
        
        $(window).resize(resizeContentWrapper);
    })(jQuery);
</script>
</body>
</html>